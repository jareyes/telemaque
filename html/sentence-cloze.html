<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2980b9">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/css/style.css">
    <title>Cloze Sentence | Telemaque</title>
    <style>
      article {
          align-items: center;
          display: flex;
          justify-content: center;
          margin: 4rem 0;
      }
      button {
          display: inline;
          margin-top: 2rem;
          background: var(--tm-color-screen);
          border: none;
          padding: 0.5rem 1rem;
      }
      #cloze {
          text-align: center;
      }
      #cloze-form {
          width: 100%;
      }
      .form-buttons {
          text-align: right;
      }
    </style>
  </head>

  <body>
    <header class="header">
      <h1>Telemaque</h1>
      <nav>
        <a id="link-back" href="/">
          <img src="/img/arrow-back.svg"> Back
        </a>
      </nav>
    </header>
    <article>
      <form id="cloze-form">
        <div id="cloze"><!-- filled in -->
        </div>
        <div class="form-buttons">
          <button class="hidden" id="cloze-refresh" type="button" disabled>Again
          </button>
          <button id="cloze-submit" type="submit">Check
          </button>
        </div>
      </form>
    </article>
    <footer class="sentence-footer">
      <nav>
        <ul>
          <li>
            <a id="link-present" href="#">Read
            </a>
          </li>
          <li>
            <a id="link-play" href="#">Listen
            </a>
          </li>
          <li>
            <a id="link-cloze" href="#">Write
            </a>
          </li>
        </ul>
      </nav>
    </footer>
    <script type="module">
      import Cloze from "/js/cloze.mjs";
      import Sentence from "/js/sentence.mjs";

      function record_attempts(
          $refresh_button,
          $submit_button,
      ) {
          return async (attempts) => {
              // Retire the submission button
              $submit_button.textContent = "Correct!";
              $submit_button.disabled = true;
              $submit_button.type = "button";

              $refresh_button.classList.remove("hidden");
              $refresh_button.disabled = false;
              $refresh_button.type = "submit";
              await Sentence.record_attempts(
                  sentence_id,
                  attempts,
              );
              console.log({
                  event: "Cloze.RECORDED",
                  sentence_id,
                  attempts,
              });
          };
      }

      function choose(words) {
          const r = Math.random();
          const choice = Math.floor(r * words.length);
          return words[choice];
      }

      const query = new URLSearchParams(window.location.search);
      const sentence_id = query.get("sentence_id");

      // Update the footer links
      const $link_present = document.getElementById("link-present");
      const $link_play = document.getElementById("link-play");
      const $link_cloze = document.getElementById("link-cloze");
      $link_present.href = `/html/sentence-present?sentence_id=${sentence_id}`;
      $link_play.href = `/html/sentence-play?sentence_id=${sentence_id}`;
      $link_cloze.href = `/html/sentence-cloze?sentence_id=${sentence_id}`;

      // Show the translation
      const sentence = await Sentence.get(sentence_id);
      const word = choose(sentence.words);

      const $form = document.getElementById("cloze-form");
      const $cloze = document.getElementById("cloze");
      const $refresh_button = document.getElementById("cloze-refresh");
      const $submit_button = document.getElementById("cloze-submit");
      const cloze = new Cloze(
          sentence,
          word,
          $cloze,
          $form,
          $refresh_button,
          $submit_button,
          record_attempts(
              $refresh_button,
              $submit_button,
          ),
      );
    </script>
  </body>
</html>
