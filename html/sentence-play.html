<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2980b9">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/css/style.css">
    <title>Add Sentence | Telemaque</title>
    <style>
      article {
          align-items: center;
          display: flex;
          justify-content: center;
          margin: 4rem 0;
      }
      #sentence-play-button {
          background: none;
          border: none;
      }
      #sentence-play-button:hover {
          color: var(--tm-color-blue);
      }
      #sentence-play-button p {
          font-weight: bold;
          text-align: center;
          font-family: system-ui, -apple-system, sans-serif;
          margin: 0;
          padding: 0;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>Telemaque</h1>
      <nav>
        <a class="nav-back" href="/">
          <img src="/img/arrow-back.svg"> Back
        </a>
      </nav>
    </header>
    <article>
      <div id="sentence-play-button">
        <img src="/img/play-circle-48dp.svg">
        <p>Play</p>
      </div>
    </article>
    <footer class="sentence-footer">
      <nav>
        <ul>
          <li>
            <a id="link-present" href="#">Read
            </a>
          </li>
          <li>
            <a id="link-play" href="#">Listen
            </a>
          </li>
          <li>
            <a id="link-cloze" href="#">Write
            </a>
          </li>
        </ul>
      </nav>
    </footer>
    <script type="module">
      import Sentence from "/js/sentence.mjs";
      import Speech from "/js/speech-client.mjs";
      import Text from "/js/text.mjs";

      const query = new URLSearchParams(window.location.search);
      const sentence_id = query.get("sentence_id");

      // Update the footer links
      const $link_present = document.getElementById("link-present");
      $link_present.href = `/html/sentence-present?sentence_id=${sentence_id}`;

      const $link_play = document.getElementById("link-play");
      $link_play.href = `/html/sentence-play?sentence_id=${sentence_id}`;

      const $link_cloze = document.getElementById("link-cloze");
      $link_cloze.href = `/html/sentence-cloze?sentence_id=${sentence_id}`;

      // Attach the audio to the play button
      const sentence = await Sentence.get(sentence_id);
      const {language_code} = await Text.get(sentence.text_id);
      const buffer = await Sentence.get_audio(sentence_id, language_code);
      const blob = new Blob(
          [buffer],
          {type: "audio/wav"},
      );
      const $play_button = document.getElementById("sentence-play-button");
      $play_button.classList.remove("invisible");
      $play_button.addEventListener("click", async () => {
          const audio_url = URL.createObjectURL(blob);
          const audio = new Audio(audio_url);
          audio.addEventListener("ended", () => {
              URL.revokeObjectURL(url);
          });
          await audio.play();
      });
    </script>
  </body>
</html>
