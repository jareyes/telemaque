<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2980b9">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/css/style.css">
    <title>Add Sentence | Telemaque</title>
    <style>
      .word {
          margin: 0.15rem;
      }
    </style>
  </head>

  <body>
    <header class="header">
      <h1>Telemaque</h1>
      <nav>
        <a class="nav-back" href="/">
          <img src="/img/arrow-back.svg"> Back
        </a>
      </nav>
    </header>
    <article>
      <header class="subheader">
        <h1 id="text-title"><!-- Filled in --></h1>
        <h2 class="meta" id="text-author"><!-- Filled in --></h2>
      </header>
      <section class="hidden meta labeled" id="section-sentence-previous">
        <span class="label">Previous sentence</span>
        <p id="sentence-previous"><!-- Filled in -->
        </p>
      </section>


      <form id="form-sentence">
        <div class="form-field">
          <label for="original">Enter</label>
          <input name="original" id="sentence-input" type="text"
          placeholder="Type new sentence">
        </div>

        <div class="form-field">
          <label for="annotation">Annotate</label>
          <div name="annotation" id="sentence-editor">
          </div>
        </div>

        <div class="form-field">
          <label for="translation">Translate</label>
          <input name="translation" type="text" placeholder="Add translation">
        </div>

        <div class="form-field">
          <label for="note">Note</label>
          <textarea name="note" placeholder="Optional notes"></textarea>
        </div>

        <input type="submit" value="Add">
      </form>
    </article>
    <script type="module">
      import Sentence from "/js/sentence.mjs";
      import SentenceEditor from "/js/sentence-editor.mjs";
      import Text from "/js/text.mjs";

      async function load_text(text_id) {
          const text = await Text.get(text_id);
          if(text_id === undefined) {
              // Nothing to see here. Go home
              return window.location.href = "/";
          }

          if(text === null) {
              // Nothing to see here. Go home
              return window.location.href = "/";
          }

          const $title = document.getElementById("text-title");
          const $author = document.getElementById("text-author");
          $title.textContent = text.title;
          $author.textContent = text.author;

/*          const sentence_id = await Sentence.get_last(text_id);
          if(sentence_id !== null) {
              const sentence = await Sentence.get(sentence_id);
              if(sentence.original === null) {
                  return;
              }
              const $sentence_previous = document.getElementById("sentence-previous");
              $sentence_previous.textContent = sentence.original;
              const $section = document.getElementById("section-sentence-previous");
              $section.classList.remove("hidden");
              }
*/
          // Add the editor
          const $sentence_input = document.getElementById("sentence-input");
          const $editor_container = document.getElementById("sentence-editor");
          const language_code = text.language_code;
          const editor = new SentenceEditor(
              language_code,
              text_id,
              $sentence_input,
              $editor_container,
          );
          console.log("editor", editor);

          // Hook up the form
          const $form = document.getElementById("form-sentence");
          $form.addEventListener(
              "submit",
              async (event) => {
                  // Don't go to the server. Stay right now
                  event.preventDefault();
                  const form_data = new FormData($form);
                  const translation = form_data.get("translation") ?? null;
                  const note = form_data.get("note");
                  await editor.save(translation, note);
                  // Let's add another sentence
                  window.location.href = `/html/sentence-create?text_id=${text_id}`;
              },
          );
      }

      const query = new URLSearchParams(window.location.search);
      const text_id = query.get("text_id");
      // Load the text
      load_text(text_id);
    </script>
  </body>
</html>
