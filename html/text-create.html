<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2980b9">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/css/style.css">
    <title>Telemaque</title>
  </head>

  <body>
    <header class="header">
      <h1>Telemaque</h1>
      <nav>
        <a class="nav-back" href="/">
          <img src="/img/arrow-back.svg"> Back
        </a>
      </nav>
    </header>
    <article>
      <h1>Add a new text</h1>
      <form id="form-text">
        <div class="form-field form-required">
          <label for="title">Title</label>
          <input required name="title" type="text">
        </div>

        <div class="form field form-required">
          <label for="language_code">Language</label>
          <select required id="language-dropdown" name="language_code">
          </select>
        </div>

        <div class="form-field">
          <label for="author">Author</label>
          <input name="author" type="text">
        </div>

        <div class="form-field">
          <label for="description">Description</label>
          <textarea name="description"></textarea>
        </div>

        <input type="submit" value="Add">
      </form>
    </article>
  </body>

  <script type="module">
    import Text from "/js/text.mjs";
    import Language from "/js/language.mjs";

    const $language_dropdown = document.getElementById("language-dropdown");
    const languages = await Language.list();
    for(const language of languages) {
        const $option = document.createElement("option");
        $option.textContent = language.language_name;
        $option.value = language.language_code;
        $language_dropdown.appendChild($option);
    }
    
    async function create_text(form_data) {
        const title = form_data.get("title");
        const author = form_data.get("author");
        const description = form_data.get("description")
        // Create the text
        const text_id = await Text.create({
            title,
            author,
            description,
            // TODO: Make language selectable from form
            language_code: "it",
        });
        console.log({
            event: "TextCreate.CREATE",
            title,
            author,
            description,
            text_id,
        });
        // Let's look at it on its own page
        window.location.href=`/html/text-detail?text_id=${text_id}`;
    }
    
    // Get the form
    const $form = document.getElementById("form-text");
    $form.addEventListener("submit", async (event) => {
        // Don't go to the server. Stay right here
        event.preventDefault();
        const form_data = new FormData($form);
        await create_text(form_data);
    });
  </script>
</html>
